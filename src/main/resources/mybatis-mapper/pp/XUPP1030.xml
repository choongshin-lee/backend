<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mom.backend.XUPP1030">
	<select id="get_findBtn1" parameterType="java.util.HashMap" resultType="com.mom.backend.dto.LowerHashMap" fetchSize="1000">
	<if test="startPage != null and startPage != '' and endPage != null and endPage != ''">
    SELECT A.*
	FROM   (
	</if>  
		    SELECT MD.COMPANY_CD
                 , MD.DIVISION_CD
                 , MD.DEMAND_ID
                 , MD.DEMAND_TYPE
                 , MD.PRIORITY
                 , MD.DESCRIPTION
                 , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(MD.COMPANY_CD,MD.DIVISION_CD, 'PP0001', MD.DEMAND_TYPE, #{langCd, jdbcType=VARCHAR}) FROM DUAL) AS DEMAND_TYPE_NM     
                 , MD.ITEM_ID
                 , MI.ITEM_NM
                 , MI.ITEM_TYPE
                 , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(MD.COMPANY_CD,MD.DIVISION_CD, 'MD0002', MI.ITEM_TYPE, #{langCd, jdbcType=VARCHAR}) FROM DUAL) AS ITEM_TYPE_NM     
                 , MI.ITEM_SPEC
                 , TO_CHAR(MD.DUE_DATE ,'YYYY-MM-DD') AS DUE_DATE
                 , MD.UOM
                 , (SELECT MOM_COMMON_PKG.FN_GET_UNIT_NAME(MD.COMPANY_CD, MD.DIVISION_CD, MD.UOM) FROM DUAL) AS UOM_NM
                 , MD.QTY
                 , NVL(MWO.GOOD_QTY, 0)  AS WO_RESULT_QTY
                 , NVL(MWO.CLOSE_QTY,0) AS CLOSE_QTY
                 , MD.QTY - NVL(MWO.GOOD_QTY, 0) - NVL(MWO.CLOSE_QTY,0) AS REMAIN_QTY
                 , MD.WORK_CENTER_CD
                 , (SELECT MOM_COMMON_PKG.FN_GET_WORK_CENTER_NAME(MD.COMPANY_CD, MD.DIVISION_CD, MD.WORK_CENTER_CD) FROM DUAL) AS WORK_CENTER_NM
                 , MWO.WORK_ORDER_ID
                 , MSD.SO_NO
                 , MSD.SO_SEQ
                 , (SELECT TO_CHAR(MSM.SO_DATE ,'YYYY-MM-DD') 
                    FROM   MOM_SO_MST MSM 
                    WHERE  MSM.COMPANY_CD  = MSD.COMPANY_CD
		            AND    MSM.DIVISION_CD = MSD.DIVISION_CD
		            AND    MSM.SO_NO       = MSD.SO_NO )  AS SO_DATE
                 , MD.UPDATE_BY  AS UPDATE_USER_NO
                 ,(SELECT MOM_COMMON_PKG.FN_GET_USER_NAME(MD.COMPANY_CD, MD.DIVISION_CD, MD.UPDATE_BY) FROM DUAL ) AS UPDATE_USER_NM
                 , TO_CHAR(MD.UPDATE_DATE ,'YYYY-MM-DD HH24:MI:SS') AS UPDATE_DATE
                 , DECODE(NVL(MD.CONFIRM_FLAG, 'N'), 'Y', 'N', 'Y')            AS MODIFY_YN   
		         , ROWIDTOCHAR(MD.ROWID) AS KEY_ID
	             , COUNT(*) OVER() AS TOTAL_COUNT
	             , ROW_NUMBER() OVER(PARTITION BY MD.COMPANY_CD,MD.DIVISION_CD ORDER BY MD.DEMAND_ID ) AS ROW_CNT 
            FROM   MOM_DEMAND MD
                 , MOM_ITEM   MI
                 , MOM_WORK_ORDER MWO
                 , MOM_SO_DTL MSD
            WHERE  MD.COMPANY_CD     = MI.COMPANY_CD
            AND    MD.DIVISION_CD    = MI.DIVISION_CD
            AND    MD.ITEM_ID        = MI.ITEM_ID
            AND    MD.COMPANY_CD     = MWO.COMPANY_CD(+)
            AND    MD.DIVISION_CD    = MWO.DIVISION_CD(+)
            AND    MD.DEMAND_ID      = MWO.DEMAND_ID(+)
            AND    MD.COMPANY_CD     = MSD.COMPANY_CD(+)
            AND    MD.DIVISION_CD    = MSD.DIVISION_CD(+)
            AND    MD.SALES_ORDER_ID = MSD.SALES_ORDER_ID(+)
            AND    MD.COMPANY_CD     = #{companyCd, jdbcType=VARCHAR}
            AND    MD.DIVISION_CD    = #{divisionCd, jdbcType=VARCHAR}
            AND    MD.DUE_DATE BETWEEN TO_DATE(#{dueDateSD, jdbcType=VARCHAR}, 'YYYY-MM-DD')  AND TO_DATE(#{dueDateED, jdbcType=VARCHAR}, 'YYYY-MM-DD') + 0.99999
            <if test="demandId != null and demandId != ''">
            AND (UPPER(MD.DEMAND_ID) LIKE '%' || UPPER(#{demandId , jdbcType=VARCHAR}) || '%' )
            </if>
            <if test="demandType != null and demandType != ''">
            AND MD.DEMAND_TYPE IN (${demandType})
            </if>	
            <if test="itemIdNm != null and itemIdNm != ''">
            AND (UPPER(MD.ITEM_ID) LIKE '%' || UPPER(#{itemIdNm, jdbcType=VARCHAR}) || '%' OR UPPER(MI.ITEM_NM) LIKE '%' || UPPER(#{itemIdNm, jdbcType=VARCHAR}) || '%')	  
            </if>
            <if test="workCenterCd != null and workCenterCd != ''">
            AND MD.WORK_CENTER_CD IN (${workCenterCd})
            </if>	
            <if test="searchRemainCheck != null and searchRemainCheck != ''">		
                <choose>
                    <when test='searchRemainCheck.equals("1")'>	 	 
                    <![CDATA[  	AND MD.QTY - NVL(MWO.GOOD_QTY, 0) - NVL(MWO.CANCEL_QTY,0) > 0	]]> 
		   	        </when>
                    <when test='searchRemainCheck.equals("2")'>
                    <![CDATA[  AND MD.QTY - NVL(MWO.GOOD_QTY, 0) - NVL(MWO.CANCEL_QTY,0) = 0 ]]> 
                    </when>    
                </choose>		
            </if>
    <if test="startPage != null and startPage != '' and endPage != null and endPage != ''">
	       ) A
	WHERE ROW_CNT BETWEEN #{startPage, jdbcType=INTEGER} AND #{endPage, jdbcType=INTEGER}
	</if>
    </select>
	<select id="proc_customBtn1-1" statementType="CALLABLE" parameterType="java.util.HashMap" resultType="com.mom.backend.dto.LowerHashMap">  
    { CALL MOM_PP_PKG.MAIN( #{p_err_code, jdbcType=VARCHAR, mode=OUT}
                          , #{p_err_msg,  jdbcType=VARCHAR, mode=OUT}
                          , #{companyCd,  jdbcType=VARCHAR, mode=IN}
                          , #{divisionCd, jdbcType=VARCHAR, mode=IN}		
                          , 'PRE'									  
                          , #{userId,     jdbcType=VARCHAR, mode=IN} )}       	              
    </select>    
</mapper>