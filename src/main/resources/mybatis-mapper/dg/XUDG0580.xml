<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mom.backend.XUDG0580">
<select id="get_findBtn21" parameterType="java.util.HashMap" resultType="com.mom.backend.dto.LowerHashMap">
    <if test="startPage != null and startPage != '' and endPage != null and endPage != ''">
        SELECT A.*
        FROM   (
    </if>
                WITH C_WO AS (SELECT MWO.COMPANY_CD
				                   , MWO.DIVISION_CD
				                   , MWO.WORK_ORDER_ID
				                   , MWR.WO_RESULT_ID
				                   , MWR.STATE
				              FROM   MOM_WORK_ORDER MWO
				                   , MOM_WO_RESULT  MWR
				              WHERE  MWO.COMPANY_CD    = MWR.COMPANY_CD(+)
				              AND    MWO.DIVISION_CD   = MWR.DIVISION_CD(+)
				              AND    MWO.WORK_ORDER_ID = MWR.WORK_ORDER_ID(+)
				              AND    MWO.COMPANY_CD    = #{companyCd, jdbcType=VARCHAR}
				              AND    MWO.DIVISION_CD   = #{divisionCd, jdbcType=VARCHAR}
				              AND    MWO.WORK_ORDER_ID = #{workOrderId, jdbcType=VARCHAR}
				              AND    MWR.STATE(+) IN ('O','R','H'))
                SELECT A.COMPANY_CD
				     , A.DIVISION_CD
				     , A.SPC_TYPE
				     , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(A.COMPANY_CD, A.DIVISION_CD, 'MD0051', A.SPC_TYPE, #{langCd, jdbcType=VARCHAR}) FROM DUAL)  AS SPC_TYPE_NM
				     , A.ITEM_ID
				     , A.OPERATION_ID
				     , (SELECT MOM_COMMON_PKG.FN_GET_OPERATION_NAME(A.COMPANY_CD, A.DIVISION_CD, A.OPERATION_ID) FROM DUAL ) AS OPERATION_NM
				     , MI.ITEM_NM
				     , MI.ITEM_SPEC
				     , MI.ITEM_TYPE
				     , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(MI.COMPANY_CD, MI.DIVISION_CD, 'MD0002', MI.ITEM_TYPE, #{langCd, jdbcType=VARCHAR}) FROM DUAL)  AS ITEM_TYPE_NM
				     , A.INSPECTION_METHOD
				     , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(A.COMPANY_CD,A.DIVISION_CD, 'MD0040', A.INSPECTION_METHOD, #{langCd, jdbcType=VARCHAR}) FROM DUAL) AS INSPECTION_METHOD_NM
				     , A.INSPECTION_LIST
				     , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(A.COMPANY_CD,A.DIVISION_CD, 'MD0041', A.INSPECTION_LIST, #{langCd, jdbcType=VARCHAR}) FROM DUAL) AS INSPECTION_LIST_NM
				     , A.INSPECTION_SPEC
				     , A.INSPECTION_UOM
				     , (SELECT MOM_COMMON_PKG.FN_GET_UNIT_NAME(A.COMPANY_CD, A.DIVISION_CD, A.INSPECTION_UOM) FROM DUAL) AS INSPECTION_UOM_NM 
				     , A.INSPECTION_EQUIPMENT
				     , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(A.COMPANY_CD,A.DIVISION_CD, 'MD0042', A.INSPECTION_EQUIPMENT, #{langCd, jdbcType=VARCHAR}) FROM DUAL) AS INSPECTION_EQUIPMENT_NM
				     , A.SAMPLING_INSPECTION_TYPE
				     , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(A.COMPANY_CD,A.DIVISION_CD, 'MD0043', A.SAMPLING_INSPECTION_TYPE, #{langCd, jdbcType=VARCHAR}) FROM DUAL) AS SAMPLING_INSPECTION_TYPE_NM
				     , A.SAMPLING_COUNT
				     , A.SPC_VALUE
				     , A.SORT_NO
				     , A.SL_MEASURE_TYPE
				     , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(A.COMPANY_CD,A.DIVISION_CD, 'MD0044', A.SL_MEASURE_TYPE, #{langCd, jdbcType=VARCHAR}) FROM DUAL) AS SL_MEASURE_TYPE_NM
				     , A.SL
				     , A.USL
				     , A.LSL
				     , A.AQL
				     , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(A.COMPANY_CD,A.DIVISION_CD, 'MD0046', A.AQL, #{langCd, jdbcType=VARCHAR}) FROM DUAL) AS AQL_NM
				     , A.INSPECTION_LEVEL
				     , (SELECT MOM_COMMON_PKG.FN_GET_CODE_NAME(A.COMPANY_CD,A.DIVISION_CD, 'MD0046', A.INSPECTION_LEVEL, #{langCd, jdbcType=VARCHAR}) FROM DUAL) AS INSPECTION_LEVEL_NM
				     , A.UPDATE_BY
				     , (SELECT MOM_COMMON_PKG.FN_GET_USER_NAME(A.COMPANY_CD, A.DIVISION_CD, A.UPDATE_BY) FROM DUAL ) AS UPDATE_USER_NM
				     , A.UPDATE_DATE
				     , #{workOrderId, jdbcType=VARCHAR}    AS WORK_ORDER_ID
				     , A.WO_RESULT_ID     AS WO_RESULT_ID
				     , A.KEY_ID
				     , COUNT(*) OVER()   AS TOTAL_COUNT
				     , ROW_NUMBER() OVER(PARTITION BY A.COMPANY_CD,A.DIVISION_CD ORDER BY A.SPC_TYPE, A.SORT_NO) AS ROW_CNT
				     , A.DESCRIPTION
				FROM  ( SELECT MIS.COMPANY_CD
				             , MIS.DIVISION_CD
				             , '10'             AS SPC_TYPE
				             , MIS.ITEM_ID
				             , MIS.OPERATION_ID
				             , MIS.INSPECTION_METHOD
				             , MIS.INSPECTION_LIST
				             , MIS.INSPECTION_SPEC
				             , MIS.INSPECTION_UOM
				             , MIS.INSPECTION_EQUIPMENT
				             , MIS.SAMPLING_INSPECTION_TYPE
				             , MIS.SAMPLING_COUNT
				             , MIS.SPC_VALUE
				             , MIS.SORT_NO
				             , MIS.SL_MEASURE_TYPE
				             , MIS.SL
				             , MIS.USL
				             , MIS.LSL
				             , MIS.AQL
				             , MIS.INSPECTION_LEVEL
				             , MIS.UPDATE_BY
				             , TO_CHAR(MIS.UPDATE_DATE ,'YYYY-MM-DD HH24:MI:SS') AS UPDATE_DATE
				             , MIS.DESCRIPTION
				             , ROWIDTOCHAR(MIS.ROWID)            AS KEY_ID
				             , C.WO_RESULT_ID
				        FROM   MOM_WO_PQC_SPEC MIS
						     , C_WO C
		                WHERE  MIS.COMPANY_CD     = C.COMPANY_CD
		                AND    MIS.DIVISION_CD    = C.DIVISION_CD
		                AND    MIS.WORK_ORDER_ID  = C.WORK_ORDER_ID
				        AND    MIS.OPERATION_ID   = #{operationId, jdbcType=VARCHAR}     
				        AND    C.WO_RESULT_ID IS  NULL
				        UNION ALL    
				        SELECT MIS.COMPANY_CD
				             , MIS.DIVISION_CD
				             , MRV.SPC_TYPE
				             , MIS.ITEM_ID
				             , MIS.OPERATION_ID
				             , MIS.INSPECTION_METHOD
				             , MIS.INSPECTION_LIST
				             , MIS.INSPECTION_SPEC
				             , MIS.INSPECTION_UOM
				             , MIS.INSPECTION_EQUIPMENT
				             , MIS.SAMPLING_INSPECTION_TYPE
				             , MIS.SAMPLING_COUNT
				             , MRV.SPC_VALUE
				             , MIS.SORT_NO
				             , MIS.SL_MEASURE_TYPE
				             , MIS.SL
				             , MIS.USL
				             , MIS.LSL
				             , MIS.AQL
				             , MIS.INSPECTION_LEVEL
				             , MIS.UPDATE_BY
				             , TO_CHAR(MIS.UPDATE_DATE ,'YYYY-MM-DD HH24:MI:SS') AS UPDATE_DATE
				             , MIS.DESCRIPTION
				             , ROWIDTOCHAR(MRV.ROWID)            AS KEY_ID
				             , C.WO_RESULT_ID
				        FROM   MOM_WO_OP_SPC_RESULT_DTL MRV
				             , MOM_WO_PQC_SPEC MIS
				             , C_WO C
				        WHERE  MRV.COMPANY_CD      = MIS.COMPANY_CD
				        AND    MRV.DIVISION_CD     = MIS.DIVISION_CD
				        AND    MRV.WORK_ORDER_ID   = MIS.WORK_ORDER_ID
				        AND    MRV.OPERATION_ID    = MIS.OPERATION_ID
				        AND    MRV.INSPECTION_LIST = MIS.INSPECTION_LIST
				        AND    MRV.COMPANY_CD      = C.COMPANY_CD
                        AND    MRV.DIVISION_CD     = C.DIVISION_CD
                        AND    MRV.WORK_ORDER_ID   = C.WORK_ORDER_ID
				        AND    MRV.OPERATION_ID    = #{operationId, jdbcType=VARCHAR}     
				        AND    MRV.SPC_END_YN = 'N'     
				        )   A  
				    , MOM_ITEM MI
				WHERE A.COMPANY_CD  = MI.COMPANY_CD
				AND   A.DIVISION_CD = MI.DIVISION_CD
				AND   A.ITEM_ID     = MI.ITEM_ID                    
				ORDER BY SPC_TYPE, SORT_NO
    <if test="startPage != null and startPage != '' and endPage != null and endPage != ''">
               ) A
        WHERE ROW_CNT BETWEEN #{startPage, jdbcType=INTEGER} AND #{endPage, jdbcType=INTEGER}
    </if> 
</select>  
    <delete id="remove_customBtn21-1" parameterType="java.util.List">
        DELETE FROM MOM_PROC_WO_SPC_RESULT
        <where>
	        <foreach collection="list" item="item" open="" close="" separator="OR">
	        (       COMPANY_CD       = #{item.companyCd, jdbcType=VARCHAR}
	           AND  DIVISION_CD      = #{item.divisionCd, jdbcType=VARCHAR}
	           AND  BUTTON_TYPE	     = 'S'
	           AND  CREATE_BY        = #{item.userId, jdbcType=VARCHAR}
	        )
	        </foreach>
        </where>
   </delete>  
   <insert id="create_customBtn21-1" parameterType="java.util.List">
       <foreach item="item" collection="list" index="i" separator=" " open="INSERT ALL" close="SELECT * FROM DUAL"> 
	       INTO MOM_PROC_WO_SPC_RESULT( COMPANY_CD
									  , DIVISION_CD
									  , BUTTON_TYPE
									  , SPC_TYPE
									  , WORK_ORDER_ID
									  , WO_RESULT_ID
									  , ITEM_ID
									  , OPERATION_ID
								   	  , INSPECTION_LIST
									  , SPC_VALUE
									  , DESCRIPTION
									  , DEL_YN
									  , VAL_MSG
									  , MULTI_MSG
									  , CREATE_BY
									  , CREATE_DATE)
           VALUES                     ( #{item.companyCd, jdbcType=VARCHAR}  
			                          , #{item.divisionCd, jdbcType=VARCHAR}
			                          , 'S' 
			                          , #{item.spcType, jdbcType=VARCHAR} 
			                          , #{item.workOrderId, jdbcType=VARCHAR} 
			                          , #{item.woResultId, jdbcType=VARCHAR} 
			                          , #{item.itemId, jdbcType=VARCHAR}
			                   		  , #{item.operationId, jdbcType=VARCHAR}
					                  , #{item.inspectionList, jdbcType=VARCHAR}
					                  , #{item.spcValue, jdbcType=NUMERIC}
					                  , #{item.description, jdbcType=VARCHAR}
					                  , #{item.delYn, jdbcType=VARCHAR}
					                  , #{item.valMsg, jdbcType=VARCHAR}
					                  , #{item.multiMsg, jdbcType=VARCHAR}
					                  , #{item.userId, jdbcType=VARCHAR}
					                  , MOM_COMMON_PKG.FN_GET_LOCAL_TIME(#{item.companyCd, jdbcType=VARCHAR},#{item.divisionCd, jdbcType=VARCHAR})
					                  )
        </foreach>
    </insert>
    <select id="proc_customBtn21-1" statementType="CALLABLE" parameterType="java.util.HashMap" resultType="com.mom.backend.dto.LowerHashMap">  
        { CALL MOM_WO_PKG.SP_CREATE_WO_SPC_RESULT( #{p_err_code,  jdbcType=VARCHAR, mode=OUT}
                                                 , #{p_err_msg,   jdbcType=VARCHAR, mode=OUT}
                                                 , #{companyCd,   jdbcType=VARCHAR, mode=IN}
                                                 , #{divisionCd,  jdbcType=VARCHAR, mode=IN} 
                                                 , 'S'
                                                 , #{userId,      jdbcType=VARCHAR, mode=IN} )}     
    </select>    
    <delete id="remove_customBtn21-2" parameterType="java.util.List">
        DELETE FROM MOM_PROC_WO_SPC_RESULT
        <where>
	        <foreach collection="list" item="item" open="" close="" separator="OR">
	        (       COMPANY_CD       = #{item.companyCd, jdbcType=VARCHAR}
	           AND  DIVISION_CD      = #{item.divisionCd, jdbcType=VARCHAR}
	           AND  BUTTON_TYPE	     = 'E'
	           AND  CREATE_BY        = #{item.userId, jdbcType=VARCHAR}
	        )
	        </foreach>
        </where>
   </delete>  
   <insert id="create_customBtn21-2" parameterType="java.util.List">
       <foreach item="item" collection="list" index="i" separator=" " open="INSERT ALL" close="SELECT * FROM DUAL"> 
	       INTO MOM_PROC_WO_SPC_RESULT( COMPANY_CD
									  , DIVISION_CD
									  , BUTTON_TYPE
									  , SPC_TYPE
									  , WORK_ORDER_ID
									  , WO_RESULT_ID
									  , ITEM_ID
									  , OPERATION_ID
								   	  , INSPECTION_LIST
									  , SPC_VALUE
									  , DESCRIPTION
									  , DEL_YN
									  , VAL_MSG
									  , MULTI_MSG
									  , CREATE_BY
									  , CREATE_DATE)
           VALUES                     ( #{item.companyCd, jdbcType=VARCHAR}  
			                          , #{item.divisionCd, jdbcType=VARCHAR}
			                          , 'E' 
			                          , #{item.spcType, jdbcType=VARCHAR} 
			                          , #{item.workOrderId, jdbcType=VARCHAR} 
			                          , #{item.woResultId, jdbcType=VARCHAR} 
			                          , #{item.itemId, jdbcType=VARCHAR}
			                   		  , #{item.operationId, jdbcType=VARCHAR}
					                  , #{item.inspectionList, jdbcType=VARCHAR}
					                  , #{item.spcValue, jdbcType=NUMERIC}
					                  , #{item.description, jdbcType=VARCHAR}
					                  , #{item.delYn, jdbcType=VARCHAR}
					                  , #{item.valMsg, jdbcType=VARCHAR}
					                  , #{item.multiMsg, jdbcType=VARCHAR}
					                  , #{item.userId, jdbcType=VARCHAR}
					                  , MOM_COMMON_PKG.FN_GET_LOCAL_TIME(#{item.companyCd, jdbcType=VARCHAR},#{item.divisionCd, jdbcType=VARCHAR})
					                  )
        </foreach>
    </insert>
    <select id="proc_customBtn21-2" statementType="CALLABLE" parameterType="java.util.HashMap" resultType="com.mom.backend.dto.LowerHashMap">  
        { CALL MOM_WO_PKG.SP_CREATE_WO_SPC_RESULT( #{p_err_code,  jdbcType=VARCHAR, mode=OUT}
                                                 , #{p_err_msg,   jdbcType=VARCHAR, mode=OUT}
                                                 , #{companyCd,   jdbcType=VARCHAR, mode=IN}
                                                 , #{divisionCd,  jdbcType=VARCHAR, mode=IN} 
                                                 , 'E'
                                                 , #{userId,      jdbcType=VARCHAR, mode=IN} )}     
    </select>    
</mapper>    